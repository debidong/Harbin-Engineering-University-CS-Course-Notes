# 计算机组成原理

*Author: Yang Bowen*

*Last modified: 2022/5/8*

# 1 系统总线

## 总线分类

- 片内总线
- 通信总线
- 系统总线
    - 数据总线
    - 地址总线
    - 控制总线

## 总线性能

- 总线复用
- 时钟同步异步
- 总线带宽

## 总线结构

- 单总线结构
- 多总线结构

## 总线控制

- 总线判优控制
    - 链式查询
    - 计数器定时查询
    - 独立请求方式
- 总线通用控制
    - 同步通信
    - 异步通信
        - 不互锁
        - 半互锁
        - 全互锁
    - 半同步通信

## 存储器

### 存储器分类

- 辅存（外存）
    - 磁带
    - 磁盘
    - 闪存 flash
    - 光盘
- 内存（主存）
    - RAM
        - SRAM
        - DRAM
    - ROM
    - 缓存 cache

### 存储器层次

- CPU-缓存-主存-辅存

# 2 计算机的运算方法

## 数值型数据

### 进制转换

- 10 -> 2
    - 整数：除二取余
    - 浮点数：乘二取整
- 2 -> 10
    - 按权相加
- 2 -> 16
- 16 -> 2

### 无符号数和有符号数

- 无符号数
- 有符号数
    - 机器数是如何表示真值的
    - 原码表示法
        - 127 ~ 127
    - 反码表示法
      
        范围同原码
        
        - 正：反=原
        - 负：符号位不变，数值为按位反
    - 补码表示法
        - 128 ~ 127 0只有一个
        - 正：补=原
        - 负：符号位不变，数值位按位反+1
    - 移码表示法
      
        和补码相比，数值位相同，符号位相反 0只有一个
        
        - 正：符号位取反
        - 负：符号位取反，数值位取反+1

### 数的定点表示和浮点表示

- 定点表示
- 浮点表示
  
    阶符+阶码位+数符+数码位
    
    - 浮点数的表示范围
    - 浮点数的规格化
        - N = +-R^E * M
          
            M为尾数，位数决定数值的精度 E为阶码，位数决定数的精度 R为阶码底数，默认为2
            
            - 原码：规格化后尾数最高位为1
              
                最高位指符号位下一位
                
            - 补码
                - 正数：1
                - 负数：0
        - IEEE754
            - 32位
                - 符号位S：0正1负
                - 阶码E：移码
                  
                    8位 阶码偏移2^7-1 = 127
                    
                - 尾数M：纯小数
                  
                    真值 = 1 + M
                
            - 64位
                - 符号位S：0正1负
                - 阶码E：移码
                  
                    11位 阶码偏移2^10 - 1= 1023
                    
                - 尾数M：纯小数
                  
                    真值 = 1 + M

## 字符型数据

- ASCII码
    - 总字符128
    - 代码宽度7b
    - 存储宽度8b（1奇偶校验位）
- 汉字编码
    - 汉字输入码
        - 数字码
        - 拼音码

## ALU

## 数值运算

- 定点运算
    - 移位运算
        - 算数移位规则
        - 算数移位和逻辑移位的区别
        - 乘法运算
    - 加法运算与减法运算
        - 补码加法
        - 溢出判断
            - 一位符号位
            - 两位符号位
    - 乘法运算
        - 原码乘法
        - 补码乘法
    - 除法运算
        - 原码除法
            - 恢复余数法
            - 加减交替法
        - 补码除法
            - 恢复余数法
            - 加减交替法
- 浮点运算
    - 浮点加法减法运算
    - 浮点乘除法

# 3 CPU结构功能

## CPU功能

- 指令控制
    - PC
    - IR
- 操作控制
    - CU
    - 时序电路
- 时序控制
    - CU
    - 时序电路
- 数据加工
    - ALU
    - 寄存器
- 中断处理
    - 中断系统

## CPU结构

### 寄存器

- 用户可见寄存器
  
    用户不可见寄存器：流水段之间的寄存器
    
    - 通用寄存器
      
        存放操作数 可用来寻址
        
    - 数据寄存器
      
        存放操作数 两个寄存器接存存放双字长数据
        
    - 地址寄存器
    - 条件码寄存器
      
        条件码可作为程序分支的依据 比如 进位 溢出
    
- 控制和状态寄存器
  
    一个典型的指令周期中， ​PC -> MAR -> M -> MDR -> IR
    
    - MAR: Memory Address Register 存储器地址寄存器
      
        用户不可见
        
    - MDR: Memory Data Register 存储器数据寄存器
      
        用户不可见
        
    - PC: Program counter 程序寄存器
      
        兼有储存程序和计数之功能 是一个控制器
        
    - IR: Instruction register 指令寄存器
      
        用来存放正在执行的指令，它的输出包括操作码信息、地址信息等，是产生微命令的主要逻辑依据。通常在主存的数据寄存器和指令寄存器之间建立直传通路，以提高速度。
        
    - PSW 程序状态字寄存器
      
        Program status word‘ 保存程序运行的状态 程序状态字较长，可达千位

### CU

产生全部指令的微操作命令序列

### 运算部件

- 输入逻辑
- ALU
  
    算数逻辑运算部件
    
- 输出逻辑

### 时序系统

- 时钟脉冲
  
    时钟脉冲经过一系列计数分频，产生所需的节拍（时钟周期）信号或更长的工作周期（机器周期）信号。
    
- 节拍
  
    一个周期可能包含若干个节拍
    
- 工作周期
  
    一次总线操作所需的时间 又名机器周期

### CPU内部数据通路结构

总线

# 4 指令周期

CPU从主存取出一条指令+执行一条指令的时间 每条指令的指令周期不同

## 完整指令周期

- 取址周期
  
    是否采用间址寻址
    
    - 取指令
- 间址周期
    - 取地址
- 执行周期
  
    是否需要中断
    
    - 存取操作数或结果
- 中断周期
    - 存程序断点

## 指令周期数据流

- 取址周期数据流
    - PC MAR ABUS M
    - CU CBUS M
    - M DBUS MDR IR
- 间址周期数据流
  
    MDR的更新
    
    - MDR MAR ABUS M
    - CU CBUS M
    - M DBUS MDR
- 执行周期数据流
- 中断周期数据流
    - CU MAR ABUS M
    - CU CBUS M
    - PC MDR DBUS M
      
        保存PC中的指令
        
    - CU PC
      
        由CU给出中断服务程序的入口地址

## 指令流水

并行性

- 指令的二级流水
  
    理想情况下速度提高一倍
    
    - 在取指令部件和执行指令部件之间加入指令部件缓冲区
    - 条件转移指令对流水效率影响较大
      
        当遇到条件转移指令时，下一条指令是不可知的，因为必须等到执行阶段结束后，才能获知条件是否成立，从而决定下条指令的地址，造成时间损失。
    
- 指令的六级流水
    - 取指 FI
      
        会访存
        
    - 指令译码 DI
    - 计算操作数地址 CO
    - 取操作数 FO
    - EI
    - 写操作数 WO
- 影响流水线性能的因素
    - 结构相关
    - 数据相关
    - 控制相关
- 流水线性能
    - 吞吐律
    - 加速比
    - 效率
    - 多发技术

# 5 中断系统

实现方式：软件+硬件

## 引发中断的原因

- 人为设置的中断
- 程序性事故
- 硬件故障
- IO设备
- 外部事件
  
    键盘触发中断

## 触发中断相关

- 中断请求标记 INTR
  
    中断源向CPU提出请求
    
- 中断判优逻辑
  
    响应哪个中断 中断源在任意时间只能响应一个中断请求
    
    - 硬件实现 排队器
        - 链式排队器
          
            分布在中断源的接口电路中
            
        - 集中在CPU内
    - 软件实现
      
        程序查询法
    
- 中断服务程序入口地址的寻找
    - 硬件向量法
    - 软件查询法
- 中断响应
    - 响应中断条件
        - EINT = 1
          
            开中断
        
    - 响应中断时间
        - 指令执行周期结束，CPU发出查询信号
    - 中断隐指令
      
        由计算机硬件完成 ENTI = 0
        
        - 保护程序段点
        - 寻找服务程序入口地址
        - 硬件 关闭终端
- 保护现场和恢复现场
    - 保护现场
        - 断点
            - 中断隐指令完成
        - 寄存器内容
            - 中断服务程序完成
    - 恢复现场
        - 中断服务程序完成
- 多重中断
  
    执行中断服务程序的过程中有更重要的中断源出现
    
    - 优先级别高的中断源有权中断优先级别低的中断源

# 6 指令系统

机器指令之和： ​计算机执行某类操作的信息的集合

## 指令构造

- 指令格式
  
    操作码+地址码
    
    - 四地址指令
      
        用指令计数器PC指示指令地址
        
    - 三地址指令
    - 二地址指令
    - 一地址指令
    - 零地址指令
      
        用于堆栈或特殊指令操作
    
- 操作数

## 寻址方式

- 指令寻址
    - 顺序寻址
    - 跳跃寻址
    
- 数据寻址
  
    操作码+寻址特征+形式地址
    
    - 立即寻址
      
        形式地址为操作数
        
    - 直接寻址
      
        EA = A
        
    - 隐含寻址
      
        有助于缩短指令字长
        
    - 间接寻址
      
        EA = (A)
        
    - 寄存器寻址
      
        EA = R
        
    - 寄存器间接寻址
      
        EA = (R)
        
    - 基址寻址
      
        EA = A + (BR) BR：专用基址寄存器
        
    - 变址寻址
      
        EA = A + (IX) IX：变址寄存器
        
    - 相对寻址
      
        EA = A + (PC)
        
    - 堆栈寻址
    
    > - CISC
    >
    >   Complex instruction set computer
    >
    > - RISC
    >
    >   Reduced instruction set computer
    >
    >   - 指令条数少
    >   - 指令长度固定
    >   - 只有取数/存数指令访问寄存器

## 指令功能和类型

指令分类
- 按指令格式
    - 单操作数指令
    - 双操作数指令
- 按操作数寻址方式
    - RR型 寄存器-寄存器
    - RX 寄存器-变址寄存器
- 按指令功能
    - 数据传送指令
    - I/O指令
    - 算术逻辑运算指令
    - 程序控制指令
        - 转子指令 返回指令
        - 转移指令
        - 软中断指令
        - 面向操作系统的指令

# 7 控制单元

## 微操作命令分析

- 取址周期
- 间指周期
- 执行周期
    - 非访存指令
    - 访存指令
        - 加法指令 ADD X
        - 存数指令 STA X
        - 取数指令 LDA X
    - 转移指令
      
        也不访问存储器
        
        - 无条件转移指令 JMP X
        - 有条件转移指令 BAN X